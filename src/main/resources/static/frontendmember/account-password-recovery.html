<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>EZdom | 忘記密碼</title>
    <!-- SEO Meta Tags-->
    <meta name="description" content="Around - Multipurpose Bootstrap HTML Template">
    <meta name="keywords"
          content="bootstrap, business, corporate, coworking space, services, creative agency, dashboard, e-commerce, mobile app showcase, saas, multipurpose, product landing, shop, software, ui kit, web studio, landing, dark mode, html5, css3, javascript, gallery, slider, touch, creative">
    <meta name="author" content="Createx Studio">
    <!-- Viewport-->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Favicon and Touch Icons-->
    <link rel="apple-touch-icon" sizes="180x180" href="../frontendshop/assets/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../frontendshop/assets/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../frontendshop/assets/favicon/favicon-16x16.png">
    <link rel="manifest" href="../frontendshop/assets/favicon/site.webmanifest">
    <link rel="mask-icon" color="#6366f1" href="../frontendshop/assets/favicon/safari-pinned-tab.svg">
    <meta name="msapplication-TileColor" content="#080032">
    <meta name="msapplication-config" content="../frontendshop/assets/favicon/browserconfig.xml">
    <meta name="theme-color" content="white">
    <!-- 加 Swal-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.1.5/dist/sweetalert2.min.css">
    <!-- Theme mode-->
    <script>
        let mode = window.localStorage.getItem('mode'),
          root = document.getElementsByTagName('html')[0];
        if (mode !== undefined && mode === 'dark') {
          root.classList.add('dark-mode');
        } else {
          root.classList.remove('dark-mode');
        }


    </script>
    <!-- Page loading styles-->
    <style>
        .page-loading {
          position: fixed;
          top: 0;
          right: 0;
          bottom: 0;
          left: 0;
          width: 100%;
          height: 100%;
          -webkit-transition: all .4s .2s ease-in-out;
          transition: all .4s .2s ease-in-out;
          background-color: #fff;
          opacity: 0;
          visibility: hidden;
          z-index: 9999;
        }

        .dark-mode .page-loading {
          background-color: #121519;
        }

        .page-loading.active {
          opacity: 1;
          visibility: visible;
        }

        .page-loading-inner {
          position: absolute;
          top: 50%;
          left: 0;
          width: 100%;
          text-align: center;
          -webkit-transform: translateY(-50%);
          transform: translateY(-50%);
          -webkit-transition: opacity .2s ease-in-out;
          transition: opacity .2s ease-in-out;
          opacity: 0;
        }

        .page-loading.active>.page-loading-inner {
          opacity: 1;
        }

        .page-loading-inner>span {
          display: block;
          font-family: 'Inter', sans-serif;
          font-size: 1rem;
          font-weight: normal;
          color: #6f788b;
        }

        .dark-mode .page-loading-inner>span {
          color: #fff;
          opacity: .6;
        }

        .page-spinner {
          display: inline-block;
          width: 2.75rem;
          height: 2.75rem;
          margin-bottom: .75rem;
          vertical-align: text-bottom;
          background-color: #d7dde2;
          border-radius: 50%;
          opacity: 0;
          -webkit-animation: spinner .75s linear infinite;
          animation: spinner .75s linear infinite;
        }

        .dark-mode .page-spinner {
          background-color: rgba(255, 255, 255, .25);
        }

        @-webkit-keyframes spinner {
          0% {
            -webkit-transform: scale(0);
            transform: scale(0);
          }

          50% {
            opacity: 1;
            -webkit-transform: none;
            transform: none;
          }
        }

        @keyframes spinner {
          0% {
            -webkit-transform: scale(0);
            transform: scale(0);
          }

          50% {
            opacity: 1;
            -webkit-transform: none;
            transform: none;
          }
        }
    </style>
    <!-- Page loading scripts-->
    <script>
        (function () {
          window.onload = function () {
            const preloader = document.querySelector('.page-loading');
            preloader.classList.remove('active');
            setTimeout(function () {
              preloader.remove();
            }, 1500);
          };
        })();

    </script>
    <!-- Import Google Font-->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&amp;display=swap"
          rel="stylesheet"
          id="google-font">
    <!-- Vendor styles-->
    <!-- Main Theme Styles + Bootstrap-->
    <link rel="stylesheet" media="screen" href="../frontendshop/assets/css/theme.min.css">
</head>
<!-- Body-->

<body>
<!-- Page loading spinner-->
<div class="page-loading active">
    <div class="page-loading-inner">
        <div class="page-spinner"></div>
        <span>Loading...</span>
    </div>
</div>
<!-- Page wrapper-->
<main class="page-wrapper">
    <!-- Page content-->
    <div class="d-flex flex-column align-items-center position-relative h-100 px-3 pt-5">
        <!-- Home button--><a
            class="text-nav btn btn-icon bg-light border rounded-circle position-absolute top-0 end-0 zindex-2 p-0 mt-3 me-3 mt-sm-4 me-sm-4"
            href="index.html" data-bs-toggle="tooltip" data-bs-placement="left" title="回首頁"><i
            class="ai-home"></i></a>
        <!-- Content-->
        <div class="mt-auto" style="max-width: 700px;" id="inArea">
            <h1 class="pt-3 pb-2 pb-lg-3">忘記密碼了嗎？</h1>
            <p class="pb-2">只需三個簡單步驟即可更改您的密碼。</p>
            <ul class="list-unstyled pb-2 pb-lg-0 mb-4 mb-lg-5">
                <li class="d-flex mb-2"><span class="text-primary fw-semibold me-2">1.</span>在下方填寫您的帳號和密碼。
                </li>
                <li class="d-flex mb-2"><span class="text-primary fw-semibold me-2">2.</span>我們將向您的信箱發送一個驗證碼。
                </li>
                <li class="d-flex mb-2"><span class="text-primary fw-semibold me-2">3.</span>輸入正確的驗證碼，即可更改密碼。
                </li>
            </ul>
            <div class="card dark-mode border-0 bg-primary">
                <form class="card-body">
                    <div class="mb-4">
                        <div class="position-relative"><i
                                class="ai-user fs-lg position-absolute top-50 start-0 translate-middle-y text-light opacity-80 ms-3"></i>
                            <input class="form-control form-control-lg ps-5" type="text" placeholder="帳號" required
                                   id="account"
                                   onblur="validateAccount()">
                        </div>
                        <p id="accountnameError" style="color: red;"></p>
                        <div class="position-relative"><i
                                class="ai-mail fs-lg position-absolute top-50 start-0 translate-middle-y text-light opacity-80 ms-3"></i>
                            <input class="form-control form-control-lg ps-5" type="email" placeholder="信箱" required
                                   id="mail"
                                   onblur="validateMail()">
                        </div>
                        <p id="mailError" style="color: red;"></p>
                    </div>
                    <button class="btn btn-light" type="submit"
                            style="font-size: 16px; padding: 5px 10px; display: block; margin: 0 auto;"
                            id="checkButton">獲取驗證碼
                    </button>
                    <link rel="stylesheet" href="">
                </form>
            </div>
        </div>
        <!-- Copyright-->
        <p class="w-100 fs-sm pt-5 mt-auto mb-5" style="max-width: 700px;"><span class="text-muted">&copy; All rights
          reserved. Made by</span><a class="nav-link d-inline-block p-0 ms-1" href="https://createx.studio/"
                                     target="_blank" rel="noopener">Createx Studio</a></p>
    </div>
</main>
<!-- Back to top button--><a class="btn-scroll-top" href="#top" data-scroll>
    <svg viewBox="0 0 40 40" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
        <circle cx="20" cy="20" r="19" fill="none" stroke="currentColor" stroke-width="1.5" stroke-miterlimit="10">
        </circle>
    </svg>
    <i class="ai-arrow-up"></i></a>
<!-- Vendor scripts: js libraries and plugins-->
<script src="../frontendshop/assets/vendor/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
<script src="../frontendshop/assets/vendor/smooth-scroll/dist/smooth-scroll.polyfills.min.js"></script>
<!-- Main theme script-->
<script src="../frontendshop/assets/js/theme.min.js"></script>
<!-- 加 Swal -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.1.5/dist/sweetalert2.all.min.js"></script>
console.log(Swal);
<!-- JQuery -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<!-- 獲取驗證碼 -->
<script>
    const account = document.getElementById('account');
    const mail = document.getElementById('mail');
    const checkButton = document.getElementById('checkButton');

    // 帳號信箱格式驗證
    function validateAccount() {
      let accountnameError = document.getElementById("accountnameError");
      if (!account.value.trim()) {
        accountnameError.textContent = "帳號不可為空";
        return false;
      } else {
        accountnameError.textContent = "";
        return true;
      }
    }

    function validateMail() {
      let mailError = document.getElementById("mailError");
      var emailRegex = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}$/;
      if (!mail.value.trim()) {
        mailError.textContent = "信箱不可為空";
        return false;
      } else if (!emailRegex.test(mail.value)) {
        mailError.textContent = "請輸入正確格式";
        return false;
      } else {
        mailError.textContent = "";
        return true;
      }
    }

    // 監聽按鈕點擊事件
    checkButton.addEventListener('click', function (event) {
      event.preventDefault(); // 阻止表單提交

      // 驗證帳號和郵箱輸入是否有效
      if (validateAccount() && validateMail()) {
        // 向後端發送 POST 請求
        fetch('http://localhost:8080/ezdom/member/checkEmailAccount', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            account: account.value,
            email: mail.value
          })
        }).then(response => {
          // 獲取 HTTP 狀態碼
          const statusCode = response.status;

          // 判斷狀態碼並進行相應處理
          if (statusCode === 200) {
            // 解析 JSON
            response.json().then(data => {
              // 從後端獲取 account 和 email
              const { account, email } = data;
              // 登入成功的處理
              Swal.fire({
                icon: 'success',
                title: '成功',
                text: '驗證成功！',
                confirmButtonText: '確定',
                focusConfirm: true
              }).then(() => {
                // 在這裡處理成功後的操作
                sendAuthenticationCode(account, email);
                // 更新頁面上的 account 和 email
                const inArea = document.getElementById('inArea');
                inArea.innerHTML = '';

                inArea.innerHTML = `
              <div class="card dark-mode border-0 bg-primary">
                <div class="card-body">
                  <div class="mb-4">
                    <div class="position-relative"><i
                      class="ai-user fs-lg position-absolute top-50 start-0 translate-middle-y text-light opacity-80 ms-3"></i>
                      <input class="form-control form-control-lg ps-5" type="text" value="${account}" disabled="disabled">
                    </div>
                    <br>
                    <div class="position-relative"><i
                      class="ai-mail fs-lg position-absolute top-50 start-0 translate-middle-y text-light opacity-80 ms-3"></i>
                      <input class="form-control form-control-lg ps-5" type="email" value="${email}" disabled="disabled">
                    </div>
                    <br>
                    <div class="position-relative"><i
                      class="fs-lg position-absolute top-50 start-0 translate-middle-y text-light opacity-80 ms-3"></i>
                      <input class="form-control form-control-lg ps-5" type="text" placeholder="驗證碼" required id="authCode">
                      <span id="acctMsg" style="visibility: hidden;color: red;">請輸入驗證碼</span>
                    </div>
                    <p id="checkMsg" style="visibility: hidden;color: red;font-size: 10px;margin-top: 30px;">驗證碼不正確</p>
                  </div>
                  <p id="checkMsg"
									style="visibility: hidden;color: red;font-size: 10px;margin-top: 30px;">
									          驗證碼不正確</p>
                  <button class="btn btn-light" type="submit"
                    style="font-size: 16px; padding: 5px 10px; display: block; margin: 0 auto;"
                    onclick="checkAuthCode('${account}')">下一步</button>
                </div>
              </div>`;
              });
            });
          } else if (statusCode === 400) {
            // 驗證失敗的處理
            response.json().then(data => {
              Swal.fire({
                icon: 'error',
                title: '失敗',
                text: '查無此帳戶 !',
                confirmButtonText: '確定',
                focusConfirm: false
              });
            });
          } else {
            // 其他狀態碼處理
            throw new Error("HTTP 錯誤: " + statusCode);
          }
        }).catch(error => {
          // 處理 fetch 發生的錯誤
          console.error("Fetch 錯誤:", error);
        });
      }
    });


    function sendAuthenticationCode(account, email) {
      fetch('http://localhost:8080/ezdom/member/sendAuthenticationCode', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          account: account,
          email: email
        })
      })
    }


    // 按下 "下一步"
    function checkAuthCode(account) {
      const authCodeValue = $("div#inArea").find("input#authCode").val(); // 獲取 authCode 的值
      console.log(authCodeValue); // 將 authCode 的值輸出到控制台

      fetch(`http://localhost:8080/ezdom/member/checkAuthCode?authCode=${authCodeValue}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
      })
        .then(response => {
          // 獲取 HTTP 狀態碼
          const statusCode = response.status;

          // 判斷狀態碼並進行相應處理
          if (statusCode === 200) {
            // 解析 JSON
            response.json().then(data => {
              // 登入成功的處理
              Swal.fire({
                icon: 'success',
                title: '成功',
                text: '驗證成功！',
                confirmButtonText: '確定',
                focusConfirm: true
              }).then(() => {
                // 在這裡處理成功後的操作
                const inArea = document.getElementById('inArea');
                inArea.innerHTML = '';
                inArea.innerHTML = `
                <div class="card dark-mode border-0 bg-primary">
                <div class="card-body">
                    <div>
                        <label for="newPassword" style="width:100px" placeholder="輸入密碼： "></label>
                            <input type="password" id="newPassword" name="newPassword" style="font-size: 16px;width: 200px;">
                                <span id="newPasswordMsg" style="visibility: hidden;color: red;">請輸入密碼</span>
                    </div>
                    <div>
                        <label for="confirmPassword" style="width:100px" placeholder="確認密碼： "></label>
                            <input type="password" id="confirmPassword" name="confirmPassword" style="font-size: 16px;width: 200px;">
                                <span id="confirmPasswordMsg" style="visibility: hidden;color: red;">請再次輸入密碼</span>
                    </div>
                            <button class="btn btn-primary btn-round padder loginSubmit"style="margin-top:20px; width: 50%; transform: translate(50%)"
                                onclick="resetPassword()">確定更改</button>
                </div>
              </div>`;
              });
            });
          } else if (statusCode === 401) {
            // 驗證失敗的處理
            response.json().then(data => {
              Swal.fire({
                icon: 'error',
                title: '失敗',
                text: '請重新輸入驗證碼 !',
                confirmButtonText: '確定',
                focusConfirm: false
              });
            });
          } else {
            // 其他狀態碼處理
            throw new Error("HTTP 錯誤: " + statusCode);
          }
        }).catch(error => {
          // 處理 fetch 發生的錯誤
          console.error("Fetch 錯誤:", error);
        });
    }


    const password = document.getElementById('newPassword');
    const confirmPassword = document.getElementById('confirmPassword');



    // 按下 "確定修改"
    function resetPassword() {


        const newPasswordValue = $("div#inArea").find("input#newPassword").val(); // 獲取 newPassword 的值
        console.log(newPasswordValue); // 將 newPasswordValue 的值輸出到控制台

        fetch(`http://localhost:8080/ezdom/member/resetPassword?newPassword=${newPasswordValue}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
        }).then(response => {
          // 獲取 HTTP 狀態碼
          const statusCode = response.status;

          // 判斷狀態碼並進行相應處理
          if (statusCode === 200) {
            // 解析 JSON
            response.json().then(data => {
              // 登入成功的處理
              Swal.fire({
                icon: 'success',
                title: '成功',
                text: '修改成功！',
                confirmButtonText: '確定',
                focusConfirm: true
              }).then(() => {
                // 成功處理
                window.location.replace("account-signin.html");
                return;
              });
            });
          } else if (statusCode === 400) {
            // 驗證失敗的處理
            response.json().then(data => {
              Swal.fire({
                icon: 'error',
                title: '失敗',
                text: '修改失敗 !',
                confirmButtonText: '確定',
                focusConfirm: false
              });
            });
          } else {
            // 其他狀態碼處理
            throw new Error("HTTP 錯誤: " + statusCode);
          }
        }).catch(error => {
          // 處理 fetch 發生的錯誤
          console.error("Fetch 錯誤:", error);
        });

    }

</script>

</body>

</html>